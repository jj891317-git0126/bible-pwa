<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <title>성경 통독 (평일 · 크리스마스 제외)</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      margin: 0;
      background: #ffffff;
      color: #0f172a;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
    }
    h1 { margin: 0; font-size: 18px; }
    .sub { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .pill {
      background: #f1f5f9;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
    }
    .btn {
      border: 1px solid #e2e8f0;
      background: #fff;
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .btnPrimary {
      background: #0f172a;
      color: #fff;
    }
    .btnDanger { border-color: #fecaca; }
    input[type="date"], select, input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 13px;
    }
    .search { margin-top: 10px; display: flex; gap: 8px; }
    main { padding-bottom: 40px; }
    .row {
      display: flex;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      align-items: center;
    }
    .row.done { background: #f6fff6; }
    .day {
      width: 95px;
      font-weight: 800;
      font-size: 13px;
      white-space: pre-line;
    }
    .title { flex: 1; }
    .t1 { font-size: 14px; font-weight: 800; }
    .t2 { margin-top: 4px; font-size: 12px; color: #475569; }
    .check { font-size: 20px; }
  </style>
</head>

<body>
<header>
  <h1>성경 통독 (평일 · 크리스마스 제외)</h1>

  <div class="sub">
    <span class="pill" id="todayBox">오늘 분량: -</span>
    <button class="btn btnPrimary" id="goTodayBtn">오늘로 이동</button>
    <span class="pill" id="progressAll">전체: -</span>
    <span class="pill" id="progressOT">구약: -</span>
    <span class="pill" id="progressNT">신약: -</span>
  </div>

  <div class="sub">
    시작일 <input type="date" id="startDate" />
    <select id="viewMode">
      <option value="all">전체</option>
      <option value="todo">미완료</option>
      <option value="done">완료</option>
    </select>
    <button class="btn" id="exportBtn">백업</button>
    <label class="btn">
      복원 <input type="file" id="importFile" accept="application/json" style="display:none">
    </label>
    <button class="btn btnDanger" id="resetBtn">초기화</button>
  </div>

  <div class="search">
    <input id="q" type="text" placeholder="검색: 창세기, 요한복음, Day 120">
    <button class="btn" id="clearSearch">지우기</button>
  </div>
</header>

<main id="list"></main>

<script>
const STORAGE_CHECKS = "bible_checks_final";
const STORAGE_START  = "bible_start_final";

let PLAN = [];
let CHECKS = {};
let DAY_TO_DATE = {};
let FILTER = "";
let VIEW_MODE = "all";

const NT_BOOKS = new Set([
  "Matthew","Mark","Luke","John","Acts","Romans","1 Corinthians","2 Corinthians",
  "Galatians","Ephesians","Philippians","Colossians","1 Thessalonians","2 Thessalonians",
  "1 Timothy","2 Timothy","Titus","Philemon","Hebrews","James","1 Peter","2 Peter",
  "1 John","2 John","3 John","Jude","Revelation"
]);

const BOOK_KO = {
  "Genesis":"창세기","Exodus":"출애굽기","Leviticus":"레위기","Numbers":"민수기","Deuteronomy":"신명기",
  "Joshua":"여호수아","Judges":"사사기","Ruth":"룻기","1 Samuel":"사무엘상","2 Samuel":"사무엘하",
  "1 Kings":"열왕기상","2 Kings":"열왕기하","1 Chronicles":"역대상","2 Chronicles":"역대하",
  "Ezra":"에스라","Nehemiah":"느헤미야","Esther":"에스더","Job":"욥기","Psalms":"시편",
  "Proverbs":"잠언","Ecclesiastes":"전도서","Song of Solomon":"아가","Isaiah":"이사야",
  "Jeremiah":"예레미야","Lamentations":"예레미야애가","Ezekiel":"에스겔","Daniel":"다니엘",
  "Hosea":"호세아","Joel":"요엘","Amos":"아모스","Obadiah":"오바댜","Jonah":"요나",
  "Micah":"미가","Nahum":"나훔","Habakkuk":"하박국","Zephaniah":"스바냐","Haggai":"학개",
  "Zechariah":"스가랴","Malachi":"말라기","Matthew":"마태복음","Mark":"마가복음",
  "Luke":"누가복음","John":"요한복음","Acts":"사도행전","Romans":"로마서",
  "1 Corinthians":"고린도전서","2 Corinthians":"고린도후서","Galatians":"갈라디아서",
  "Ephesians":"에베소서","Philippians":"빌립보서","Colossians":"골로새서",
  "1 Thessalonians":"데살로니가전서","2 Thessalonians":"데살로니가후서",
  "1 Timothy":"디모데전서","2 Timothy":"디모데후서","Titus":"디도서",
  "Philemon":"빌레몬서","Hebrews":"히브리서","James":"야고보서",
  "1 Peter":"베드로전서","2 Peter":"베드로후서","1 John":"요한일서",
  "2 John":"요한이서","3 John":"요한삼서","Jude":"유다서","Revelation":"요한계시록"
};

const WD_KO = ["일","월","화","수","목","금","토"];

function isWeekend(d){ return d.getDay()===0 || d.getDay()===6; }
function isChristmas(d){ return d.getMonth()===11 && d.getDate()===25; }
function isOffDay(d){ return isWeekend(d) || isChristmas(d); }
function fmtDate(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} (${WD_KO[d.getDay()]})`;
}
function bookName(b){ return BOOK_KO[b] || b; }
function isNT(b){ return NT_BOOKS.has(b); }

function buildDayMap(start){
  const map = {};
  let d = new Date(start+"T00:00:00");
  while(isOffDay(d)) d.setDate(d.getDate()+1);
  for(let day=1; day<=PLAN.length; day++){
    while(isOffDay(d)) d.setDate(d.getDate()+1);
    map[day]=fmtDate(d);
    d.setDate(d.getDate()+1);
  }
  return map;
}

function updateToday(){
  const start = localStorage.getItem(STORAGE_START);
  const box = document.getElementById("todayBox");
  if(!start){ box.textContent="오늘 분량: 시작일 설정 필요"; return; }
  let d = new Date(start+"T00:00:00");
  while(isOffDay(d)) d.setDate(d.getDate()+1);
  let today = new Date(); today.setHours(0,0,0,0);
  let dayNum=0;
  while(d<=today){ if(!isOffDay(d)) dayNum++; d.setDate(d.getDate()+1); }
  const item = PLAN.find(p=>p.day===dayNum);
  box.textContent = item ? `오늘 분량: Day ${dayNum} · ${item.type==="buffer"?"따라잡기/복습":item.title}` : "오늘 분량: 완료";
}

function updateStats(){
  let done=Object.values(CHECKS).filter(Boolean).length;
  document.getElementById("progressAll").textContent=`전체: ${done}/${PLAN.length}`;
  let otT=0,otD=0,ntT=0,ntD=0;
  PLAN.forEach(p=>{
    if(p.type!=="read") return;
    let nt=isNT(p.readings[0].book);
    if(nt){ntT++; if(CHECKS[p.day]) ntD++;}
    else{otT++; if(CHECKS[p.day]) otD++;}
  });
  document.getElementById("progressOT").textContent=`구약: ${otD}/${otT}`;
  document.getElementById("progressNT").textContent=`신약: ${ntD}/${ntT}`;
}

function render(){
  const root=document.getElementById("list");
  root.innerHTML="";
  PLAN.forEach(p=>{
    if(VIEW_MODE==="done" && !CHECKS[p.day]) return;
    if(VIEW_MODE==="todo" && CHECKS[p.day]) return;
    if(FILTER && !(`${p.day} ${p.title}`.includes(FILTER))) return;
    const row=document.createElement("div");
    row.className="row"+(CHECKS[p.day]?" done":"");
    row.onclick=()=>{CHECKS[p.day]=!CHECKS[p.day]; localStorage.setItem(STORAGE_CHECKS,JSON.stringify(CHECKS)); updateStats(); render();};
    row.innerHTML=`
      <div class="day">Day ${p.day}\n${DAY_TO_DATE[p.day]||""}</div>
      <div class="title">
        <div class="t1">${p.type==="buffer"?"따라잡기/복습":p.title.replace(/Genesis|Exodus|Leviticus|Numbers|Deuteronomy|Joshua|Judges|Ruth|1 Samuel|2 Samuel|1 Kings|2 Kings|1 Chronicles|2 Chronicles|Ezra|Nehemiah|Esther|Job|Psalms|Proverbs|Ecclesiastes|Song of Solomon|Isaiah|Jeremiah|Lamentations|Ezekiel|Daniel|Hosea|Joel|Amos|Obadiah|Jonah|Micah|Nahum|Habakkuk|Zephaniah|Haggai|Zechariah|Malachi|Matthew|Mark|Luke|John|Acts|Romans|1 Corinthians|2 Corinthians|Galatians|Ephesians|Philippians|Colossians|1 Thessalonians|2 Thessalonians|1 Timothy|2 Timothy|Titus|Philemon|Hebrews|James|1 Peter|2 Peter|1 John|2 John|3 John|Jude|Revelation/g,m=>BOOK_KO[m])}</div>
        <div class="t2">${p.type==="read"?p.readings.map(r=>`${bookName(r.book)} ${r.chapter}장`).join(", "):""}</div>
      </div>
      <div class="check">${CHECKS[p.day]?"✅":"⬜️"}</div>`;
    root.appendChild(row);
  });
}

async function init(){
  CHECKS=JSON.parse(localStorage.getItem(STORAGE_CHECKS)||"{}");
  const res=await fetch("./plan.json");
  const data=await res.json();
  PLAN=data.plan;
  const start=localStorage.getItem(STORAGE_START);
  if(start){ document.getElementById("startDate").value=start; DAY_TO_DATE=buildDayMap(start); }
  updateStats(); updateToday(); render();
  if("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");
}

document.getElementById("startDate").onchange=e=>{
  localStorage.setItem(STORAGE_START,e.target.value);
  DAY_TO_DATE=buildDayMap(e.target.value);
  updateToday(); render();
};
document.getElementById("viewMode").onchange=e=>{VIEW_MODE=e.target.value; render();};
document.getElementById("q").oninput=e=>{FILTER=e.target.value; render();};
document.getElementById("clearSearch").onclick=()=>{FILTER=""; document.getElementById("q").value=""; render();};
document.getElementById("goTodayBtn").onclick=()=>updateToday();
document.getElementById("resetBtn").onclick=()=>{if(confirm("초기화?")){CHECKS={}; localStorage.setItem(STORAGE_CHECKS,"{}"); updateStats(); render();}};
document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify({checks:CHECKS,start:localStorage.getItem(STORAGE_START)},null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bible-backup.json"; a.click();
};
document.getElementById("importFile").onchange=async e=>{
  const t=await e.target.files[0].text(); const j=JSON.parse(t);
  CHECKS=j.checks||{}; localStorage.setItem(STORAGE_CHECKS,JSON.stringify(CHECKS));
  if(j.start){ localStorage.setItem(STORAGE_START,j.start); document.getElementById("startDate").value=j.start; DAY_TO_DATE=buildDayMap(j.start); }
  updateStats(); updateToday(); render();
};

init();
</script>
</body>
</html>
