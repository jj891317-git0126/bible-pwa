<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <title>ì„±ê²½ í†µë… (í‰ì¼ 1ë…„)</title>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Arial,sans-serif;margin:0;background:#fff;color:#0f172a}
    header{position:sticky;top:0;z-index:10;background:#fff;padding:14px 16px;border-bottom:1px solid #eee}
    h1{margin:0;font-size:18px}
    .sub{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-size:13px;color:#334155}
    .btn{border:1px solid #e2e8f0;background:#fff;padding:7px 10px;border-radius:10px;cursor:pointer;font-size:13px;color:#0f172a}
    .btnPrimary{background:#0f172a;color:#fff}
    .btnDanger{border-color:#fecaca}
    input[type="date"],select{padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;font-size:13px;background:#fff}
    input[type="text"]{flex:1;padding:10px 12px;border:1px solid #e2e8f0;border-radius:12px;font-size:14px}
    .search{width:100%;margin-top:10px;display:flex;gap:8px}
    main{padding:8px 0 60px}
    .row{display:flex;gap:12px;padding:14px 16px;border-bottom:1px solid #f1f5f9;align-items:center}
    .row.done{background:#f6fff6}
    .day{width:120px;font-weight:900;font-size:13px;white-space:pre-line}
    .title{flex:1}
    .t1{font-size:14px;font-weight:900}
    .t2{margin-top:5px;font-size:12px;color:#475569;line-height:1.35}
    .check{font-size:20px}

    /* ì—ëŸ¬ ë°•ìŠ¤ */
    .errorBox{
      margin:12px 16px; padding:12px 12px; border:1px solid #fecaca;
      background:#fff5f5; border-radius:12px; color:#7f1d1d; font-size:13px; line-height:1.45;
      white-space:pre-wrap;
    }
    .okBox{
      margin:12px 16px; padding:10px 12px; border:1px solid #bbf7d0;
      background:#f0fdf4; border-radius:12px; color:#14532d; font-size:13px;
    }

    /* ì¶•í•˜ ëª¨ë‹¬ */
    .overlay{position:fixed;inset:0;background:rgba(15,23,42,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:999}
    .modal{width:min(420px,100%);background:#fff;border-radius:18px;padding:16px 16px 14px;box-shadow:0 18px 60px rgba(0,0,0,0.2)}
    .modal h2{margin:0;font-size:18px}
    .modal p{margin:10px 0 0;font-size:13px;color:#334155;line-height:1.45}
    .modal .actions{margin-top:14px;display:flex;justify-content:flex-end}
  </style>
</head>

<body>
<header>
  <h1>ì„±ê²½ í†µë… (í‰ì¼ 1ë…„)</h1>

  <div class="sub">
    <span class="pill" id="todayBox">ì˜¤ëŠ˜ ë¶„ëŸ‰: -</span>
    <button class="btn btnPrimary" id="goTodayBtn">ì˜¤ëŠ˜ ì´ë™</button>
    <span class="pill" id="progressAll">ì „ì²´: -</span>
    <span class="pill" id="progressOT">êµ¬ì•½: -</span>
    <span class="pill" id="progressNT">ì‹ ì•½: -</span>
  </div>

  <div class="sub">
    ì‹œì‘ì¼ <input id="startDate" type="date" />
    <select id="viewMode">
      <option value="all">ì „ì²´ ë³´ê¸°</option>
      <option value="todo">ë¯¸ì™„ë£Œë§Œ</option>
      <option value="done">ì™„ë£Œë§Œ</option>
    </select>

    <button class="btn" id="exportBtn">ë°±ì—…</button>
    <label class="btn">
      ë³µì› <input id="importFile" type="file" accept="application/json" style="display:none" />
    </label>
    <button class="btn btnDanger" id="resetBtn">ì´ˆê¸°í™”</button>
  </div>

  <div class="search">
    <input id="q" type="text" placeholder="ê²€ìƒ‰: Day 120, 1/1/26 (ëª©)" />
    <button class="btn" id="clearSearch">ì§€ìš°ê¸°</button>
  </div>
</header>

<div id="msg"></div>
<main id="list"></main>

<!-- ì¶•í•˜ ëª¨ë‹¬ -->
<div class="overlay" id="overlay">
  <div class="modal" role="dialog" aria-modal="true">
    <h2 id="celebrateTitle">ğŸ‰ í•œ ë‹¬ ì™„ë£Œ!</h2>
    <p id="celebrateBody">ì´ë²ˆ ë‹¬ ì½ê¸° í”Œëœì„ ëª¨ë‘ ì™„ë£Œí•˜ì…¨ì–´ìš”. ê³„ì† ì´ì–´ê°€ ë³´ì„¸ìš”!</p>
    <div class="actions">
      <button class="btn btnPrimary" id="celebrateClose">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
/* =========================
   ì•ˆì •í™” í¬ì¸íŠ¸
   1) iOS ë‚ ì§œ(UTCë¡œ í•˜ë£¨ ë°€ë¦¼) ë°©ì§€: parseLocalDate ì‚¬ìš©
   2) plan.json í•­ëª©ì— readings/titleì´ ì—†ì–´ë„ ì£½ì§€ ì•Šê²Œ ë°©ì–´
   3) ì–´ë–¤ JS ì—ëŸ¬ê°€ ë‚˜ë„ í™”ë©´ì— í‘œì‹œ
   ========================= */

const STORAGE_START  = "bible_start_date_v6";
const STORAGE_CHECKS = "bible_reading_checks_v6";
const STORAGE_CELEB  = "bible_month_celebrated_v6";

let PLAN = [];
let CHECKS = {};
let FILTER = "";
let VIEW_MODE = "all";

let DAY_TO_DATE_STR = {}; // day -> "1/1/26 (ëª©)"
let MONTH_TO_DAYS = {};   // "YYYY-MM" -> [day...]

const WD_KO = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

const NT_BOOKS = new Set([
  "Matthew","Mark","Luke","John","Acts","Romans",
  "1 Corinthians","2 Corinthians","Galatians","Ephesians","Philippians","Colossians",
  "1 Thessalonians","2 Thessalonians","1 Timothy","2 Timothy","Titus","Philemon",
  "Hebrews","James","1 Peter","2 Peter","1 John","2 John","3 John","Jude","Revelation"
]);

const BOOK_KO = {
  "Genesis":"ì°½ì„¸ê¸°","Exodus":"ì¶œì• êµ½ê¸°","Leviticus":"ë ˆìœ„ê¸°","Numbers":"ë¯¼ìˆ˜ê¸°","Deuteronomy":"ì‹ ëª…ê¸°",
  "Joshua":"ì—¬í˜¸ìˆ˜ì•„","Judges":"ì‚¬ì‚¬ê¸°","Ruth":"ë£»ê¸°","1 Samuel":"ì‚¬ë¬´ì—˜ìƒ","2 Samuel":"ì‚¬ë¬´ì—˜í•˜",
  "1 Kings":"ì—´ì™•ê¸°ìƒ","2 Kings":"ì—´ì™•ê¸°í•˜","1 Chronicles":"ì—­ëŒ€ìƒ","2 Chronicles":"ì—­ëŒ€í•˜",
  "Ezra":"ì—ìŠ¤ë¼","Nehemiah":"ëŠí—¤ë¯¸ì•¼","Esther":"ì—ìŠ¤ë”","Job":"ìš¥ê¸°","Psalms":"ì‹œí¸",
  "Proverbs":"ì ì–¸","Ecclesiastes":"ì „ë„ì„œ","Song of Solomon":"ì•„ê°€","Isaiah":"ì´ì‚¬ì•¼",
  "Jeremiah":"ì˜ˆë ˆë¯¸ì•¼","Lamentations":"ì˜ˆë ˆë¯¸ì•¼ì• ê°€","Ezekiel":"ì—ìŠ¤ê²”","Daniel":"ë‹¤ë‹ˆì—˜",
  "Hosea":"í˜¸ì„¸ì•„","Joel":"ìš”ì—˜","Amos":"ì•„ëª¨ìŠ¤","Obadiah":"ì˜¤ë°”ëŒœ","Jonah":"ìš”ë‚˜",
  "Micah":"ë¯¸ê°€","Nahum":"ë‚˜í›”","Habakkuk":"í•˜ë°•êµ­","Zephaniah":"ìŠ¤ë°”ëƒ","Haggai":"í•™ê°œ",
  "Zechariah":"ìŠ¤ê°€ë´","Malachi":"ë§ë¼ê¸°",
  "Matthew":"ë§ˆíƒœë³µìŒ","Mark":"ë§ˆê°€ë³µìŒ","Luke":"ëˆ„ê°€ë³µìŒ","John":"ìš”í•œë³µìŒ","Acts":"ì‚¬ë„í–‰ì „",
  "Romans":"ë¡œë§ˆì„œ","1 Corinthians":"ê³ ë¦°ë„ì „ì„œ","2 Corinthians":"ê³ ë¦°ë„í›„ì„œ","Galatians":"ê°ˆë¼ë””ì•„ì„œ",
  "Ephesians":"ì—ë² ì†Œì„œ","Philippians":"ë¹Œë¦½ë³´ì„œ","Colossians":"ê³¨ë¡œìƒˆì„œ",
  "1 Thessalonians":"ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ","2 Thessalonians":"ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ",
  "1 Timothy":"ë””ëª¨ë°ì „ì„œ","2 Timothy":"ë””ëª¨ë°í›„ì„œ","Titus":"ë””ë„ì„œ","Philemon":"ë¹Œë ˆëª¬ì„œ",
  "Hebrews":"íˆë¸Œë¦¬ì„œ","James":"ì•¼ê³ ë³´ì„œ","1 Peter":"ë² ë“œë¡œì „ì„œ","2 Peter":"ë² ë“œë¡œí›„ì„œ",
  "1 John":"ìš”í•œ1ì„œ","2 John":"ìš”í•œ2ì„œ","3 John":"ìš”í•œ3ì„œ","Jude":"ìœ ë‹¤ì„œ","Revelation":"ìš”í•œê³„ì‹œë¡"
};

function showError(txt){ document.getElementById("msg").innerHTML = `<div class="errorBox">${escapeHtml(txt)}</div>`; }
function showOK(txt){ document.getElementById("msg").innerHTML = `<div class="okBox">${escapeHtml(txt)}</div>`; }
function clearMsg(){ document.getElementById("msg").innerHTML = ""; }

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function bookName(en){ return BOOK_KO[en] || en; }
function isNT(bookEn){ return NT_BOOKS.has(bookEn); }

function parseLocalDate(yyyy_mm_dd){
  const [y,m,d] = (yyyy_mm_dd||"").split("-").map(n=>parseInt(n,10));
  if(!y||!m||!d) return null;
  return new Date(y, m-1, d); // ë¡œì»¬ ìì •
}
function toDateOnly(dt){ return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
function isWeekend(d){ const x=d.getDay(); return x===0 || x===6; }

function fmtMDYYWD(d){
  const mm=d.getMonth()+1, dd=d.getDate(), yy=String(d.getFullYear()).slice(-2), wd=WD_KO[d.getDay()];
  return `${mm}/${dd}/${yy} (${wd})`;
}
function monthKey(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function monthLabelKo(key){
  const [y,m]=key.split("-");
  return `${y}ë…„ ${parseInt(m,10)}ì›”`;
}

function rebuildMaps(){
  DAY_TO_DATE_STR = {};
  MONTH_TO_DAYS = {};

  const startStr = localStorage.getItem(STORAGE_START) || document.getElementById("startDate").value;
  if(!startStr) return;

  let d = parseLocalDate(startStr);
  if(!d) return;
  d = toDateOnly(d);

  while(isWeekend(d)) d.setDate(d.getDate()+1);

  for(let day=1; day<=PLAN.length; day++){
    while(isWeekend(d)) d.setDate(d.getDate()+1);

    DAY_TO_DATE_STR[day] = fmtMDYYWD(d);

    const mk = monthKey(d);
    if(!MONTH_TO_DAYS[mk]) MONTH_TO_DAYS[mk] = [];
    MONTH_TO_DAYS[mk].push(day);

    d.setDate(d.getDate()+1);
  }
}

function readingTitleKo(item){
  const base = (item && item.title) ? String(item.title) : "ì½ê¸°";
  // ì œëª©ì— ì˜ì–´ ì±…ëª…ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í•œê¸€ë¡œ ë³€í™˜
  let t = base;
  for (const [en, ko] of Object.entries(BOOK_KO)) t = t.split(en).join(ko);
  return t;
}
function readingDetailKo(item){
  if(!item) return "";
  if(item.type !== "read") return "ë°€ë¦° ë¶„ëŸ‰ì„ ë”°ë¼ì¡ê±°ë‚˜, ë³µìŠµ/ë¬µìƒìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.";
  const readings = Array.isArray(item.readings) ? item.readings : [];
  if(readings.length === 0) return "";
  return readings.map(r=>{
    const b = r?.book ? bookName(r.book) : "";
    const c = (r?.chapter ?? "");
    return (b && c!=="") ? `${b} ${c}ì¥` : (b || "");
  }).filter(Boolean).join(", ");
}

function dayIndexFromStartSkippingWeekends(startStr, today){
  let d = parseLocalDate(startStr);
  if(!d) return 0;
  d = toDateOnly(d);

  let t = toDateOnly(today);
  while(isWeekend(d)) d.setDate(d.getDate()+1);

  let count=0;
  while(d<=t){
    if(!isWeekend(d)) count++;
    d.setDate(d.getDate()+1);
  }
  return count;
}

function updateTodayBox(){
  const box = document.getElementById("todayBox");
  const startStr = localStorage.getItem(STORAGE_START) || document.getElementById("startDate").value;
  if(!startStr){ box.textContent="ì˜¤ëŠ˜ ë¶„ëŸ‰: ì‹œì‘ì¼ì„ ì„¤ì •í•˜ì„¸ìš”"; return; }

  const dayNum = dayIndexFromStartSkippingWeekends(startStr, new Date());
  const item = PLAN.find(p => Number(p.day) === Number(dayNum));

  if(!item){
    box.textContent = (dayNum > PLAN.length) ? "ì˜¤ëŠ˜ ë¶„ëŸ‰: ì™„ë£Œ!" : `ì˜¤ëŠ˜ ë¶„ëŸ‰: Day ${dayNum}`;
    return;
  }

  const dateStr = DAY_TO_DATE_STR[dayNum] ? ` Â· ${DAY_TO_DATE_STR[dayNum]}` : "";
  const title = (item.type === "buffer") ? "ë”°ë¼ì¡ê¸°/ë³µìŠµ" : readingTitleKo(item);
  box.textContent = `ì˜¤ëŠ˜ ë¶„ëŸ‰: Day ${dayNum}${dateStr} Â· ${title}`;
}

function updateStats(){
  const total = PLAN.length;
  const done = Object.values(CHECKS).filter(Boolean).length;
  const pct = total ? Math.round(done/total*100) : 0;
  document.getElementById("progressAll").textContent = `ì „ì²´: ${done}/${total} (${pct}%)`;

  let otT=0, otD=0, ntT=0, ntD=0;
  for(const item of PLAN){
    if(item?.type !== "read") continue;
    const readings = Array.isArray(item.readings) ? item.readings : [];
    const firstBook = readings[0]?.book;
    if(!firstBook) continue;

    const doneThis = !!CHECKS[item.day];
    if(isNT(firstBook)){ ntT++; if(doneThis) ntD++; }
    else { otT++; if(doneThis) otD++; }
  }
  document.getElementById("progressOT").textContent = `êµ¬ì•½: ${otD}/${otT} (${otT?Math.round(otD/otT*100):0}%)`;
  document.getElementById("progressNT").textContent = `ì‹ ì•½: ${ntD}/${ntT} (${ntT?Math.round(ntD/ntT*100):0}%)`;
}

function matchesFilter(item){
  const dayNum = Number(item.day);
  const done = !!CHECKS[dayNum];

  if(VIEW_MODE==="done" && !done) return false;
  if(VIEW_MODE==="todo" && done) return false;

  if(!FILTER) return true;
  const f = FILTER.toLowerCase();
  const hay = [
    `day ${dayNum}`,
    readingTitleKo(item),
    readingDetailKo(item),
    (DAY_TO_DATE_STR[dayNum]||"")
  ].join(" ").toLowerCase();
  return hay.includes(f);
}

function render(){
  const root = document.getElementById("list");
  root.innerHTML = "";
  const frag = document.createDocumentFragment();

  for(const item of PLAN){
    if(!matchesFilter(item)) continue;

    const dayNum = Number(item.day);
    const isDone = !!CHECKS[dayNum];

    const row = document.createElement("div");
    row.className = "row" + (isDone ? " done" : "");
    row.id = `day-${dayNum}`;

    row.addEventListener("click", ()=>{
      CHECKS[dayNum] = !CHECKS[dayNum];
      localStorage.setItem(STORAGE_CHECKS, JSON.stringify(CHECKS));
      updateStats();
      updateTodayBox();
      maybeCelebrateMonthlyCompletion();
      render();
    });

    const day = document.createElement("div");
    day.className = "day";
    day.textContent = `Day ${dayNum}\n${DAY_TO_DATE_STR[dayNum] || ""}`;

    const title = document.createElement("div");
    title.className = "title";

    const t1 = document.createElement("div");
    t1.className = "t1";
    t1.textContent = (item.type === "buffer") ? "ë”°ë¼ì¡ê¸°/ë³µìŠµ" : readingTitleKo(item);

    const t2 = document.createElement("div");
    t2.className = "t2";
    t2.textContent = readingDetailKo(item);

    const check = document.createElement("div");
    check.className = "check";
    check.textContent = isDone ? "âœ…" : "â¬œï¸";

    title.appendChild(t1);
    title.appendChild(t2);

    row.appendChild(day);
    row.appendChild(title);
    row.appendChild(check);

    frag.appendChild(row);
  }

  root.appendChild(frag);
}

function scrollToDay(dayNum){
  const el = document.getElementById(`day-${dayNum}`);
  if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
}

/* ----- ì›” ì™„ë£Œ ì¶•í•˜ ----- */
function getCelebratedMap(){
  try { return JSON.parse(localStorage.getItem(STORAGE_CELEB) || "{}") || {}; }
  catch { return {}; }
}
function setCelebratedMap(obj){
  localStorage.setItem(STORAGE_CELEB, JSON.stringify(obj));
}
function showCelebrate(mk){
  document.getElementById("celebrateTitle").textContent = `ğŸ‰ ${monthLabelKo(mk)} ì™„ë£Œ!`;
  document.getElementById("celebrateBody").textContent = "ì´ë²ˆ ë‹¬ì— í•´ë‹¹í•˜ëŠ” Dayë¥¼ ëª¨ë‘ ì²´í¬í•˜ì…¨ì–´ìš”. ì •ë§ ì˜í•˜ì…¨ìŠµë‹ˆë‹¤!";
  document.getElementById("overlay").style.display = "flex";
}
function maybeCelebrateMonthlyCompletion(){
  if(!Object.keys(MONTH_TO_DAYS).length) return;

  const celebrated = getCelebratedMap();
  for(const mk of Object.keys(MONTH_TO_DAYS)){
    if(celebrated[mk]) continue;
    const days = MONTH_TO_DAYS[mk] || [];
    if(!days.length) continue;
    const allDone = days.every(d => !!CHECKS[d]);
    if(allDone){
      celebrated[mk] = true;
      setCelebratedMap(celebrated);
      showCelebrate(mk);
      break;
    }
  }
}

/* ----- ë°±ì—…/ë³µì› ----- */
function exportBackup(){
  const payload = {
    savedAt: new Date().toISOString(),
    checks: CHECKS,
    startDate: (localStorage.getItem(STORAGE_START) || document.getElementById("startDate").value || null),
    celebratedMonths: getCelebratedMap()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "bible-backup.json";
  a.click();
  URL.revokeObjectURL(url);
}
async function importBackup(file){
  const text = await file.text();
  const parsed = JSON.parse(text);

  CHECKS = parsed?.checks || {};
  localStorage.setItem(STORAGE_CHECKS, JSON.stringify(CHECKS));

  if(parsed?.startDate){
    localStorage.setItem(STORAGE_START, parsed.startDate);
    document.getElementById("startDate").value = parsed.startDate;
  }
  if(parsed?.celebratedMonths){
    localStorage.setItem(STORAGE_CELEB, JSON.stringify(parsed.celebratedMonths));
  }

  rebuildMaps();
  updateStats();
  updateTodayBox();
  render();
  maybeCelebrateMonthlyCompletion();
}

/* ----- ì „ì—­ ì—ëŸ¬ë¥¼ í™”ë©´ì— í‘œì‹œ ----- */
window.addEventListener("error", (e)=>{
  showError(`ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${e?.message || e}\n\n(í•„ìš”í•˜ì‹œë©´ ì´ ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ë³´ë‚´ì£¼ì„¸ìš”)`);
});
window.addEventListener("unhandledrejection", (e)=>{
  showError(`ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${e?.reason?.message || e?.reason || e}\n\n(í•„ìš”í•˜ì‹œë©´ ì´ ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ë³´ë‚´ì£¼ì„¸ìš”)`);
});

async function init(){
  try{
    // load checks
    try { CHECKS = JSON.parse(localStorage.getItem(STORAGE_CHECKS) || "{}") || {}; }
    catch { CHECKS = {}; }

    // restore start date to input
    const savedStart = localStorage.getItem(STORAGE_START);
    if(savedStart) document.getElementById("startDate").value = savedStart;

    // load plan.json (ì´ê±´ ì´ë¯¸ ì‚¬ìš©ìê»˜ì„œ ì§ì ‘ ì—´ë¦¬ë‹ˆ OKì§€ë§Œ, ê·¸ë˜ë„ ë°©ì–´)
    const res = await fetch("plan.json", { cache: "no-store" });
    if(!res.ok) throw new Error(`plan.json ë¡œë“œ ì‹¤íŒ¨: HTTP ${res.status}`);
    const data = await res.json();
    if(!data || !Array.isArray(data.plan)) throw new Error(`plan.json í˜•ì‹ ì˜¤ë¥˜: { "plan": [...] } í˜•íƒœê°€ ì•„ë‹™ë‹ˆë‹¤.`);
    PLAN = data.plan;

    rebuildMaps();
    updateStats();
    updateTodayBox();
    render();
    maybeCelebrateMonthlyCompletion();
    clearMsg();

    // í•„ìš”í•˜ë©´ ì•„ë˜ ì¤„ ì£¼ì„ í•´ì œí•´ì„œ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ ê°€ëŠ¥
    // showOK(`ì •ìƒ ë¡œë“œ âœ… (Day ${PLAN.length} / ë‚ ì§œë§µ ${Object.keys(DAY_TO_DATE_STR).length})`);
  } catch(err){
    showError(`ë°ì´í„°ë¥¼ í‘œì‹œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n[ì›ì¸]\n${err?.message || err}`);
  }

  // service workerëŠ” ì¡´ì¬í•˜ë©´ ë“±ë¡ë§Œ (ë¬¸ì œ ì›ì¸ê³¼ ë¬´ê´€)
  if("serviceWorker" in navigator){
    try { navigator.serviceWorker.register("./sw.js"); } catch {}
  }
}

/* ----- ì´ë²¤íŠ¸ ----- */
document.getElementById("startDate").addEventListener("change",(e)=>{
  const v = (e.target.value||"").trim();
  if(!v) return;
  localStorage.setItem(STORAGE_START, v);
  rebuildMaps();
  updateTodayBox();
  render();
  maybeCelebrateMonthlyCompletion();
});

document.getElementById("viewMode").addEventListener("change",(e)=>{
  VIEW_MODE = e.target.value;
  render();
});

document.getElementById("q").addEventListener("input",(e)=>{
  FILTER = (e.target.value||"").trim();
  render();
});

document.getElementById("clearSearch").addEventListener("click",()=>{
  FILTER = "";
  document.getElementById("q").value = "";
  render();
});

document.getElementById("goTodayBtn").addEventListener("click",()=>{
  const startStr = localStorage.getItem(STORAGE_START) || document.getElementById("startDate").value;
  if(!startStr){ alert("ë¨¼ì € ì‹œì‘ì¼ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”."); return; }

  // ì˜¤ëŠ˜ì´ í•„í„°/ê²€ìƒ‰ìœ¼ë¡œ ê°€ë ¤ì¡Œì„ ìˆ˜ ìˆìœ¼ë‹ˆ í•´ì œ í›„ ìŠ¤í¬ë¡¤
  VIEW_MODE = "all";
  document.getElementById("viewMode").value = "all";
  FILTER = "";
  document.getElementById("q").value = "";

  rebuildMaps();
  updateTodayBox();
  render();

  const dayNum = dayIndexFromStartSkippingWeekends(startStr, new Date());
  setTimeout(()=>scrollToDay(dayNum), 0);
});

document.getElementById("exportBtn").addEventListener("click", exportBackup);

document.getElementById("importFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try { await importBackup(file); alert("ë³µì› ì™„ë£Œ"); }
  catch { alert("ë°±ì—… íŒŒì¼ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
  finally { e.target.value = ""; }
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(!confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  CHECKS = {};
  localStorage.setItem(STORAGE_CHECKS, JSON.stringify(CHECKS));
  updateStats();
  updateTodayBox();
  render();
});

document.getElementById("celebrateClose").addEventListener("click", ()=>{
  document.getElementById("overlay").style.display = "none";
});
document.getElementById("overlay").addEventListener("click",(e)=>{
  if(e.target.id === "overlay") e.target.style.display = "none";
});

init();
</script>
</body>
</html>
